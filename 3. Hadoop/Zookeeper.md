<h2>Zookeeper</h2>
<h3>1. Введение</h3>

Apache ZooKeeper — это централизованный сервис для поддержания конфигурационной информации, именования, обеспечения распределённой синхронизации и групповых сервисов.

Основные понятия:
- Ансамбль (Ensemble): Кластер серверов ZooKeeper. Для обеспечения отказоустойчивости необходимо нечётное количество серверов (обычно 3, 5 или 7). Ансамбль продолжает работать, если "жива" большая часть серверов (кворум).
- Сессия (Session): Когда клиент подключается к ZooKeeper, устанавливается сессия. Это состояние подключения, которое имеет тайм-аут. Клиент периодически отправляет пинги (heartbeats), чтобы поддерживать сессию активной. Если сессия разрывается, все временные узлы (ephemeral znodes), созданные этой сессией, удаляются.
- Znode: Узел в данных ZooKeeper. Это не файл и не папка в классическом понимании, а нечто среднее — znode может хранить данные (как файл) и иметь дочерние узлы (как директория). Размер данных небольшой (обычно до 1 МБ), так как ZK не предназначен для хранения больших данных.
- Watches (Наблюдатели): Механизм уведомлений. Клиент может установить "наблюдателя" на znode. При любом изменении этого znode (изменение данных, удаление, появление дочерних узлов) ZooKeeper отправляет клиенту одноразовое уведомление (watch event).
- Версии (Version): Каждое изменение znode увеличивает его версию. Это позволяет реализовывать оптимистичные блокировки — клиент может проверить, не изменилась ли версия с момента его последнего чтения.

<h4>Роль в Hadoop</h4>

Apache ZooKeeper играет важную роль в экосистеме Hadoop, обеспечивая надежное, распределенное координационное и конфигурационное сервисное решение для крупномасштабных распределенных систем. В контексте Hadoop и других распределенных приложений, ZooKeeper используется для решения нескольких ключевых задач:
- Управление конфигурацией: ZooKeeper позволяет централизованно управлять конфигурацией, делая конфигурационные данные доступными для всех узлов в кластере. Изменения в конфигурации могут быть мгновенно распространены по всем узлам, что позволяет системе быстро адаптироваться к новым настройкам.
- Синхронизация: ZooKeeper обеспечивает механизмы для синхронизации действий между узлами в кластере. Это может быть использовано для координации начала и завершения различных операций, гарантируя, что все узлы работают согласованно.
- Выборы лидера: В многих распределенных системах необходимо определить "лидера" среди группы узлов для управления определенными задачами или для принятия решений от имени группы. ZooKeeper предоставляет сервисы для проведения выборов лидера и управления процессом, гарантируя, что в любой момент времени существует только один активный лидер.
- Регистрация сервисов: ZooKeeper может использоваться для отслеживания статуса различных компонентов в системе, предоставляя регистрацию сервисов и обнаружение. Это позволяет приложениям узнавать о доступности и местоположении различных сервисов в кластере.
- Управление распределенными блокировками: Для того чтобы обеспечить корректную обработку конкурентных операций в распределенной системе, необходим механизм блокировок. ZooKeeper предоставляет API для создания и управления распределенными блокировками, что позволяет разным узлам безопасно работать с общими ресурсами.
- Обработка отказов: ZooKeeper помогает системам быстро реагировать на отказы узлов, автоматически переконфигурируя систему для обхода недоступных узлов и минимизации простоев.

<h4>Типы и особенности znode</h4>

Данные в ZooKeeper организованы в виде иерархического дерева пространства имён, очень похожего на файловую систему. Каждый узел в этом дереве — это znode. Путь к znode является абсолютным и должен начинаться с косой черты.

Существует четыре основных типа znode, которые определяют их жизненный цикл и поведение:
- Persistent (Постоянный): Существует до тех пор, пока не будет удалён явно (командой delete). Идеален для хранения конфигурационной информации, иерархии данных, которые должны переживать сессии клиентов.
- Ephemeral (Временный): Существует только во время активной сессии клиента, который его создал. Если клиент отключается (или его сессия таймаутит), znode автоматически удаляется. Идеален для представления участников кластера (ноды, брокеры, регион-серверы). Если узел падает, он автоматически "исчезает" из кластера.
- Persistent Sequential (Постоянный последовательный): При создании такого znode ZooKeeper автоматически добавляет к его имени монотонно возрастающий счётчик (например, /locks/lock-0000000001). Жизненный цикл такой же, как у Persistent znode, используется для реализации таких структур, как очереди.
- Ephemeral Sequential (Временный последовательный): Сочетает особенности Ephemeral и Sequential, автоматически удаляется при разрыве сессии. Используется для реализации выбора лидера (Leader Election): Все кандидаты создают последовательные временные узлы в одной директории. Узел с наименьшим номером становится лидером. Если лидер падает, его узел удаляется, и следующий узел с наименьшим номером автоматически становится новым лидером.

Ключевые особенности всех znode:
- Атомарность: Все операции над znode атомарны. Система гарантирует, что либо вся операция выполнится, либо не выполнится ничего.
- Наблюдатели (Watches): На любой znode можно повесить watch, что делает ZooKeeper системой, управляемой событиями.
- Версионность: Каждый znode имеет номер версии, который увеличивается при каждом изменении данных. Это предотвращает "состояние гонки" (race condition).

<h4>Файл zoo.cfg</h4>

Это основной конфигурационный файл для сервера ZooKeeper. В нем задаются параметры, необходимые для запуска и работы сервера. Вот некоторые ключевые параметры:
- `tickTime`: базовый временной интервал в миллисекундах, используемый ZooKeeper для измерения времени, например, для определения времени ожидания сессии (session timeout). Обычно устанавливается в 2000 мс (2 секунды).
- `initLimit`: время (в тиках - tickTime), которое позволяет follower-серверам подключиться к leader-серверу. Если за это время follower не успевает подключиться, то он исключается из ансамбля. Обычно устанавливается в 5 тиков (т.е. 5 * `tickTime`).
- `syncLimit`: время (в тиках), которое позволяет follower-серверам синхронизироваться с leader-сервером. Если follower отстает от leader на большее время, то он исключается из ансамбля. Обычно устанавливается в 2 тика.
- `dataDir`: директория, где ZooKeeper будет хранить снимки (snapshots) состояния данных и, если не задано иное, журнал транзакций (transaction log).
- `dataLogDir`: (опционально) директория для журнала транзакций. Если не задано, то используется `dataDir`.
- `clientPort`: порт, на котором сервер ZooKeeper будет слушать запросы от клиентов. По умолчанию 2181.
- `maxClientCnxns`: максимальное количество одновременных подключений от одного клиента (по IP). По умолчанию 60.
- `server.X`: список серверов, входящих в ансамбль. Здесь X - это идентификатор сервера (должен быть уникальным для каждого сервера). Формат: server.X=hostname:peerPort:leaderPort, где peerPort - порт для обмена данными между серверами (обычно 2888), leaderPort - порт для выборов лидера (обычно 3888).
- `autopurge.snapRetainCount`: количество снимков данных и соответствующих журналов транзакций, которые будут сохраняться после очистки (остальные удаляются). По умолчанию 3.
- `autopurge.purgeInterval`: интервал (в часах) для запуска задачи очистки. По умолчанию 0 (отключено).

Пример файла zoo.cfg:

```bash
# Основные настройки
tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181

# Настройки ансамбля
initLimit=10
syncLimit=5

# Список серверов ансамбля
server.1=192.168.1.101:2888:3888
server.2=192.168.1.102:2888:3888
server.3=192.168.1.103:2888:3888

# Дополнительные настройки
maxClientCnxns=100
autopurge.snapRetainCount=5
autopurge.purgeInterval=1
```