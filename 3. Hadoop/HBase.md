<h2>HBase</h2>
<h3>1. Архитектура и модель данных</h3>
<h4>Основные понятия</h4>

HBase — распределенная и масштабируемая база данных, основанная на технологии Hadoop и HDFS. Она предназначена для хранения и обработки больших объемов структурированных данных в режиме реального времени. HBase использует модель данных, схожую с Google's Bigtable, и предлагает возможности по работе с большими данными, которые не поддерживаются традиционными реляционными базами данных.

Модель данных HBase:
- Таблицы: Данные в HBase хранятся в таблицах. Каждая таблица состоит из строк и столбцов.
- Строки: Каждая строка идентифицируется уникальным ключом (Row Key). Строки автоматически сортируются по ключу строки, что обеспечивает быстрый доступ к данным.
- Столбцы: Столбцы группируются в семейства столбцов (HColumnFamily), которые должны быть объявлены заранее при создании таблицы. В пределах одного семейства столбцов можно динамически добавлять столбцы.
- Ячейки: Каждая ячейка данных в таблице определяется уникальной комбинацией ключа строки, семейства столбцов, идентификатора столбца и временной метки. Ячейки могут содержать несколько версий одних и тех же данных, отличающихся по временной метке.

Архитектура HBase:
- HMaster: Управляет кластером, назначает регионы региональным серверам, контролирует сбои и обеспечивает балансировку нагрузки.
- RegionServer: Обрабатывают запросы к данным, каждый из них управляет определенным набором регионов.
- Region: Таблицы в HBase делятся на регионы для распределения данных по кластеру. Каждый регион содержит строки таблицы в определенном диапазоне ключей.
- HDFS: HBase хранит данные в Hadoop Distributed File System (HDFS), что обеспечивает надежность и масштабируемость.

HBase идеально подходит для:
- Хранения больших объемов разреженных данных: Например, веб-таблицы, где у каждого сайта много возможных атрибутов, но заполнены лишь некоторые.
- Систем, требующих случайного доступа на чтение/запись: Сервисы обмена сообщениями, почтовые ящики.
- Систем, собирающих данные с временными рядами: Метрики с датчиков IoT, лог-файлы, история транзакций.
- В качестве "горячего" хранилища поверх Hadoop: Быстрый доступ к результатам агрегации или предварительно обработанным данным из HDFS.

<h4>Назначение и структура Column Family</h4>

В HBase данные организованы в таблицы, которые состоят из строк и столбцов. Но в отличие от реляционных баз, столбцы группируются в семейства столбцов (Column Families). Семейство столбцов (Column Family, CF) — это основная единица физического хранения и настройки производительности в HBase. Это логическая группировка столбцов, которые имеют общие характеристики и часто применяются вместе.

Ключевые аспекты назначения:
- Физическая группировка: Все столбцы из одного семейства хранятся вместе в файловой системе (в одних и тех же HFiles). Это позволяет эффективно читать данные из одного семейства, не загружая данные из других.
- Точка настройки: Все параметры хранения задаются на уровне семейства столбцов, а не отдельного столбца или строки:
  - Сжатие (GZIP, LZO, Snappy)
  - Версионность (количество хранимых версий значения для одной ячейки)
  - Время жизни (TTL) для автоматического удаления устаревших данных
  - Размер блока для кэширования
  - Bloom filters для ускорения поиска строк
- Семантическая группировка: Позволяет логически организовать данные. Например, в таблице `users` можно создать семейства `profile_data` (имя, email) и `activity_data` (последний вход, количество действий).

Логическая модель данных в HBase выглядит так:
```bash
Table: 'users'
Row Key: 'user123'
    Column Family: 'profile_data'
        Column Qualifier: 'name'    -> Value: 'John Doe', Timestamp: t3
        Column Qualifier: 'email'   -> Value: 'john@mail.com', Timestamp: t2
    Column Family: 'activity_data'
        Column Qualifier: 'last_login' -> Value: '2023-10-27', Timestamp: t1
        Column Qualifier: 'login_count' -> Value: '42', Timestamp: t1
```

Где:
- Row Key: `user123` — уникальный идентификатор строки.
- Column Family: `profile_data` и `activity_data` — заранее объявленные группы.
- Column Qualifier: `name`, `email`, `last_login` — динамические метки столбцов внутри семейства. Они создаются "на лету" при записи.

Имена семейств столбцов должны быть короткими строковыми константами (например, cf1, d, info), так как они повторяются для каждой ячейки. Имена квалификаторов столбцов могут быть любыми.

<h4>HLog и HFile</h4>

HLog (также известный как WAL — Write-Ahead Log) — это механизм записи операций в лог-файл перед их применением в памяти (MemStore). Каждый регион-сервер в HBase имеет один общий HLog. Его назначение - обеспечение надежности и долговечности данных при операциях записи.

Принцип работы:
1. Когда клиент отправляет запрос на запись (например, PUT), он сначала попадает в HRegionServer.
2. Перед тем как данные будут записаны в MemStore (в оперативную память), операция записывается в WAL на HDFS.
3. Только после успешной записи в WAL данные помещаются в MemStore.
4. Клиент получает подтверждение об успешной записи.

Если HRegionServer неожиданно падает, данные из его MemStore (которые находятся в RAM) теряются. При перезапуске система обнаруживает, что некоторые данные из WAL не были применены к постоянным HFiles, и воспроизводит (replays) журнал, восстанавливая тем самым потерянные операции.

HFile — это внутренний формат файлов хранения данных в HBase, основанный на формате SSTable (Google BigTable). Данные в HFile отсортированы по ключу (RowKey) и хранятся в HDFS.

Принцип работы:
1. Когда MemStore достигает определенного размера, его содержимое сбрасывается (flushed) на диск в виде нового HFile.
2. Со временем для одного региона и одного семейства столбцов накапливается множество маленьких HFile.
3. Процесс компактизации (Compaction) объединяет маленькие HFile в один большой, отсортированный HFile. Это улучшает производительность чтения и освобождает место (удаляя старые версии и удаленные ячейки).

Связь HLog и HFile:
- HLog — это последовательный журнал операций для надежности. Он быстро растет и periodically архивируется после успешного сброса MemStore в HFile.
- HFile — это отсортированное, индексированное хранилище для эффективного чтения. Это итоговое место хранения ваших данных.

<h4>Роль ZooKeeper в HBase</h4>

ZooKeeper — это распределенный сервис, который является "мозговым центром" и единым источником истины для всего кластера HBase. Без ZooKeeper кластер HBase не сможет функционировать как согласованная распределенная система. Он обеспечивает необходимый уровень координации, обнаружения сбоев и хранения критически важной метаинформации.

Ключевые роли ZooKeeper в HBase:
- Координация и выбор Лидера (Leader Election) для HMaster: В кластере может быть запущено несколько HMaster'ов для отказоустойчивости. ZooKeeper гарантирует, что в любой момент времени активен только один ("Leader"). Если активный HMaster падает, ZooKeeper немедленно инициирует выборы нового лидера.
- Регистрация и мониторинг HRegionServer: Каждый HRegionServer при запуске создает в ZooKeeper эфемерный узел (ephemeral node). HMaster "подписывается" на эти узлы и отслеживает состояние всех RegionServer'ов через механизм "heartbeat". Если связь с RegionServer'ом теряется (узел удаляется), ZooKeeper немедленно уведомляет HMaster, который запускает процедуру восстановления регионов этого сервера.
- Хранилище критических метаданных (Metadata Gateway): ZooKeeper хранит расположение корневой таблицы `hbase:meta`. Эта таблица — карта всего кластера. В ней содержится информация о том, какой регион какой таблицы обслуживается каким RegionServer'ом. Процесс обращения клиента:
  - Клиент сначала обращается к ZooKeeper, чтобы узнать, где находится `hbase:meta`.
  - Затем клиент обращается к соответствующему RegionServer'у, чтобы прочитать `hbase:meta` и узнать расположение нужного ему региона данных.
  - Получив эту информацию, клиент кэширует ее и обращается напрямую к нужному RegionServer'у.
- Распределенная синхронизация: ZooKeeper помогает координировать распределенные операции, такие как разделение регионов (region splitting), когда требуется заблокировать родительский регион перед созданием дочерних.
