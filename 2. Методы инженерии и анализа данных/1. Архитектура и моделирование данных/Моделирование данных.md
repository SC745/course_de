<h2>Моделирование данных</h2>

Моделирование данных помогает определить структуру данных, их атрибуты и взаимосвязи между ними. Это основа для проектирования базы данных, которая будет эффективно поддерживать хранение, извлечение и управление данными.

<h3>1. ER-диаграмма</h3>

ER-диаграммы представляют собой графическое представление сущностей и их взаимосвязей в базе данных. Они служат для визуализации структуры данных и облегчения понимания их взаимодействия. Основная цель ER-диаграммы — наглядно показать, какие данные будут храниться и как они связаны, прежде чем переходить к физической реализации в СУБД.

<h4>Компоненты</h4>

В основе ER-моделирования лежат три ключевых понятия:
- Сущность (Entity) — это реальный объект или понятие из предметной области, информацию о котором мы хотим хранить. Примеры: `Студент`, `Заказ`, `Книга`, `Отдел`. На диаграмме изображается прямоугольником.
- Атрибут (Attribute) — это характеристика сущности, которая описывает ее свойства. Примеры: Для сущности Студент атрибутами могут быть `ID_Студента`, `Имя`, `Фамилия`, `Дата_Рождения`. На диаграмме изображается овалом и соединяется линией с сущностью. Часто для простоты атрибуты просто перечисляют внутри прямоугольника сущности.
- Связь (Relationship) — описывает как сущности взаимодействуют друг с другом. Примеры: `Студент` "посещает" `Курс`. `Заказ` "содержит" `Товар`. На диаграмме изображается ромбом (в нотации Чена) или просто линией (в нотации "вороньей лапки").

<h4>Первичный ключ</h4>

Первичный ключ (Primary Key) — это специальный атрибут (или набор атрибутов) сущности, который однозначно идентифицирует каждый экземпляр этой сущности. На диаграмме атрибуты, входящие в первичный ключ, обычно подчеркиваются.

Требования к первичному ключу:
- Уникальность: Не может быть двух записей с одинаковым значением первичного ключа.
- Непустота: Значение первичного ключа не может быть NULL.
- Неизменность: Значение первичного ключа, как правило, не должно меняться со временем.

<h4>Типы связей между сущностями</h4>

Типы связей между сущностями определяют, сколько экземпляров одной сущности связано с экземплярами другой сущности. Существует три основных типа:
- Один-ко-многим (One-to-Many, 1:N) - Один экземпляр сущности A связан с несколькими экземплярами сущности B. Пример: Один `Отдел` может содержать многих `Сотрудников`, но каждый `Сотрудник` работает только в одном `Отделе`.
- Один-к-одному (One-to-One, 1:1) - Один экземпляр сущности A связан только с одним экземпляром сущности B. Пример: Один `Сотрудник` имеет ровно одну `ЗаписнуюКнижку`, и одна `ЗаписнаяКнижка` принадлежит ровно одному `Сотруднику`. На практике такие связи часто объединяют в одну таблицу.
- Многие-ко-многим (Many-to-Many, M:N) - Один экземпляр сущности A может быть связан со многими экземплярами сущности B, и наоборот. Пример: Один `Студент` может посещать много `Курсов`, и на одном `Курсе` может быть много `Студентов`.

<h3>2. Нормализация данных</h3>

Нормализация — это процесс организации данных в базе данных для уменьшения избыточности и улучшения целостности данных. Она заключается в разбиении таблиц на более мелкие и устранении аномалий.

<h4>Нормальные формы</h4>

Нормальная форма - требование, предъявляемое к структуре таблиц в теории реляционных баз данных для устранения из базы избыточных функциональных зависимостей между атрибутами (полями таблиц).

Существует 7 нормальных форм:
- Первая нормальная форма (1NF) - все атрибуты атомарны, в таблице нет повторяющихся групп, определен первичный ключ
- Вторая нормальная форма (2NF) - таблица находится в 1NF, все неключевые атрибуты полностью зависят от всего первичного ключа
- Третья нормальная форма (3NF) - таблица находится в 2NF, нет транзитивных зависимостей (неключевые атрибуты не зависят от других неключевых атрибутов)
- Нормальная форма Бойса-Кодда (BCNF) - таблица находится в 3NF, каждая детерминанта (атрибут, от которого зависят другие атрибуты) является потенциальным ключом
- Четвертая нормальная форма (4NF) - таблица находится в BCNF, нет нетривиальных многозначных зависимостей
- Пятая нормальная форма (5NF) - таблица находится в 4NF, не может быть разделена на меньшие таблицы без потери информации
- Доменно-ключевая нормальная форма (DKNF) - Все ограничения являются логическими следствиями ограничений доменов и ключевых ограничений, каждое отношение удовлетворяет всем ограничениям доменов и всем ключевым ограничениям

<h4>Денормализация</h4>

Денормализация иногда применяется с целью повышения производительности системы путем добавления избыточности данных. Это может быть необходимо для оптимизации производительности чтения данных за счет увеличения скорости доступа к данным и снижения числа соединений.

Преимущества:
- Улучшенная производительность чтения (более быстрая выборка данных)
- Упрощение запросов (меньше соединений таблиц в запросах)
- Лучшая производительность для аналитических систем

Недостатки:
- Избыточность данных
- Аномалии обновления
- Повышенные требования к целостности данных

<h3>3. Схемы данных для аналитических приложений</h3>

Схемы "Звезда" и "Снежинка" играют важную роль в проектировании архитектуры данных для аналитических приложений и систем BI. Выбор между этими схемами должен основываться на специфических требованиях к аналитике, производительности запросов, управлению данными и масштабируемости проекта. Оптимальное проектирование схемы данных обеспечивает эффективную основу для аналитических операций и помогает организациям принимать обоснованные бизнес-решения на основе данных.

<h4>Схема "Звезда"</h4>

Схема "Звезда" обеспечивает высокую производительность аналитических запросов благодаря своей простоте и денормализованной структуре, что делает ее идеальной для BI приложений. Она состоит из двух основных типов таблиц:
- Фактовые таблицы (Fact Tables) - расположены в центре схемы, содержат количественные данные (меры) о бизнес-процессах, включают ключи для связи с таблицами измерений, обычно очень большие (миллионы/миллиарды строк)
- Таблицы измерений (Dimension Tables) - окружают фактовую таблицу как "лучи звезды", содержат описательные атрибуты для анализа, обычно меньшего размера, служат для фильтрации, группировки и описания данных

Преимущества:
- Простота и интуитивность: Бизнес-пользователи и аналитики легко понимают модель. Запросы пишутся интуитивно.
- Высокая производительность запросов: Оптимизатору СУБД проще строить планы запросов для джойнов между одной центральной таблицей и несколькими небольшими.
- Упрощенная агрегация: Идеально подходит для операций SUM, COUNT, AVG по различным срезам данных (по времени, товарам, регионам).
- Быстрое время отклика для BI-инструментов: Такие инструменты, как Tableau, Power BI, отлично работают со "звездой", так как они визуализируют измерения и меры именно в этой логике.

Недостатки:
- Избыточность данных: Таблицы измерений могут содержать повторяющиеся данные.
- Менее гибкая для сложных иерархий: Если у вас есть многоуровневые иерархии, "Звезда" хранит их все в одной таблице измерений, что может быть неэффективно. Для этого иногда используют схему "Снежинка", которая нормализует измерения.

Этапы проектирования:
1. Определение бизнес-процессов (продажи, заказы, логистика)
2. Выбор гранулярности фактов (уровень детализации данных)
3. Определение измерений
4. Определение фактов и мер

Оптимизация запросов:
- Использование индексов (для таблицы фактов - по ключам, для таблиц измерений - по часто используемым атрибутам)
- Партицирование таблицы фактов
- Использование материализованных представлений

В некоторых случаях удобно использовать мультиуровневые фактовые таблицы (например, продажи на уровне заказа, дня или месяца). Это позволяет строить отчеты разной детализации, при этом не жертвуя производительностью.

Применение в BI и аналитических системах
- Выбор схемы: Выбор между схемой "Звезда" и "Снежинка" зависит от конкретных требований аналитического приложения или проекта BI. Схема "Звезда" часто предпочтительнее для большинства BI задач из-за ее простоты и скорости выполнения запросов.
- Оптимизация аналитики: Обе схемы оптимизируют аналитические запросы, обеспечивая быстрый доступ к данным и их эффективный анализ. Они позволяют легко агрегировать данные, проводить временные анализы и сегментировать данные по различным измерениям.
- Интеграция данных: Схемы поддерживают интеграцию данных из различных источников, что является критически важным аспектом в современных аналитических и BI системах, требующих обработки больших объемов разнородных данных.

<h4>Схема "Снежинка"</h4>

Схема "Снежинка" - это нормализованная версия схемы "Звезда", где таблицы измерений имеют иерархическую структуру и содержат ссылки на другие таблицы измерений.
- Фактовая таблица остается неизменной
- Таблицы измерений нормализованы (приведены к 3NF)
- Создаются дополнительные таблицы для иерархических атрибутов

Преимущества:
- Снижение избыточности данных
- Улучшение целостности данных (Изменения в иерархических данных делаются в одном месте)
- Экономия дискового пространства

Недостатки:
- Сложность запросов
- Снижение производительности
- Усложнение ETL-процессов

Процесс преобразования из "Звезды":
1. Анализ таблиц измерений
2. Создание нормализованых таблиц
3. Обновление таблиц измерений
4. Обновление ETL-процессов

Отличия от "Звезды":
- Нормализованная структура
- Ниже производительность
- Выше целостность данных
- Занимает меньше места
- Сложнее ETL-процессы
- Проще вносить изменения
- Поддерживает иерархические данные
- Хуже подходит для BI-систем

<h4>Временные измерения</h4>

Временные измерения позволяют анализировать данные в разрезе времени - это одно из самых важных измерений в любой аналитической системе.
Измерение даты (Date Dimension):
```sql
CREATE TABLE dim_date (
    date_key INT PRIMARY KEY,          -- YYYYMMDD
    full_date DATE NOT NULL,           -- 2024-01-15
    day_of_week INT,                   -- 1-7 (воскресенье=1)
    day_name VARCHAR(9),               -- 'Monday'
    day_of_month INT,                  -- 1-31
    day_of_year INT,                   -- 1-366
    week_of_year INT,                  -- 1-53
    week_of_month INT,                 -- 1-6
    month INT,                         -- 1-12
    month_name VARCHAR(9),             -- 'January'
    month_name_short CHAR(3),          -- 'Jan'
    quarter INT,                       -- 1-4
    quarter_name VARCHAR(2),           -- 'Q1'
    year INT,                          -- 2024
    year_month INT,                    -- 202401
    year_quarter INT,                  -- 20241

    -- Бизнес-атрибуты
    is_weekend BOOLEAN,
    is_holiday BOOLEAN,
    holiday_name VARCHAR(50),
    is_business_day BOOLEAN,
    season VARCHAR(10),                -- 'Winter', 'Spring'

    -- Относительные временные метки
    days_since_epoch INT,
    week_since_epoch INT,
    month_since_epoch INT
);
```

Измерение времени (Time Dimension):
```sql
CREATE TABLE dim_time (
    time_key INT PRIMARY KEY,          -- HHMMSS
    full_time TIME NOT NULL,           -- 14:30:45
    hour24 INT,                        -- 0-23
    hour12 INT,                        -- 1-12
    minute INT,                        -- 0-59
    second INT,                        -- 0-59
    am_pm CHAR(2),                     -- 'AM', 'PM'
    time_period VARCHAR(20),           -- 'Morning', 'Afternoon'
    shift VARCHAR(20),                 -- 'First Shift', 'Night Shift'
    hour_minute CHAR(5),               -- '14:30'

    -- Бизнес-атрибуты
    is_peak_hour BOOLEAN,
    is_working_hour BOOLEAN
);
```

Использование в фактовой таблице:
```sql
CREATE TABLE fact_sales (
    sales_id BIGINT,
    order_date_key INT,        -- Дата заказа
    ship_date_key INT,         -- Дата отгрузки
    delivery_date_key INT,     -- Дата доставки
    order_time_key INT,        -- Время заказа

    FOREIGN KEY (order_date_key) REFERENCES dim_date(date_key),
    FOREIGN KEY (ship_date_key) REFERENCES dim_date(date_key),
    FOREIGN KEY (delivery_date_key) REFERENCES dim_date(date_key),
    FOREIGN KEY (order_time_key) REFERENCES dim_time(time_key)
);
```

<h4>Хранение истории в измерениях</h4>

Медленно меняющиеся измерения (Slowly Changing Dimensions - SCD) - это метод учета изменений в данных измерений с течением времени. Типы SCD:
- Тип 0: Статическое измерение - данные никогда не меняются
- Тип 1: Перезапись (Overwrite) - старые данные теряются
- Тип 2: Добавление новой версии (Add New Row) - есть специальные столбцы для учета версии, при устаревании данных добавляется новая версия, а старая помечается как неактивная.
- Тип 3: Добавление новых столбцов (Add New Columns) - столбцы для хранения предыдущего значения
- Тип 4: История в отдельной таблице (History Table)

<h4>Иерархии в измерениях</h4>

Типы иерархий:
- Жесткая Иерархия - отношения между уровнями фиксированы и строги. Каждый элемент на нижнем уровне принадлежит ровно одному элементу на верхнем. Пример: Город → Регион → Страна. Часто реализуется через "таблицу измерений" с полями `City_ID`, `City_Name`, `Region_ID`, `Region_Name`, `Country_Name`.
- Снежинка (Snowflake) - это нормализованная структура, где каждый уровень иерархии вынесен в отдельную таблицу. Отдельная таблица `Dim_City`, связанная с `Dim_Region`, которая связана с `Dim_Country`.
- Плоская таблица (Star) - это денормализованная структура, где все атрибуты иерархии хранятся в одной таблице измерения. Пример: В таблице `Dim_Geography` есть столбцы `City_Name`, `Region_Name`, `Country_Name`.
- Неестественная (Гибкая) иерархия - отношения между уровнями могут меняться или быть множественными. Требует специальной структуры, например, таблицы связей (Bridge Table). Пример: Иерархия "Сотрудник → Менеджер". У одного сотрудника может быть несколько менеджеров (по проекту, по функционалу).

Неправильно спроектированная иерархия может привести к проблемам при агрегации, например, к проблеме двойного счета (при суммировании продаж по разным категориям товар, относящийся к двум категориям будет посчитан дважды). Запросы к иерархиям типа "Снежинка" показывают более низкую производительность, поэтому необходимо предрассчитывать и хранить данные на разных уровнях иерархии.
